<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الحسابات - مسار</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div id="header-container"></div>
    
    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    
     <!-- Main Content -->
    <main class="main-content">
        <div class="content-wrapper">
            <div class="page-header">
                <h1><i class="fas fa-users-cog"></i> إدارة الحسابات</h1>
                <p>إدارة حسابات المستخدمين والعملاء في النظام</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons" style="margin-bottom: 2rem;">
                <button class="btn btn-primary" onclick="showPendingRequests()">
                    <i class="fas fa-clock"></i> طلبات التسجيل المعلقة
                </button>
                <button class="btn btn-warning" onclick="showRejectedRequests()">
                    <i class="fas fa-times-circle"></i> الطلبات المرفوضة
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> تصدير إلى Excel
                </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="form-container">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                    <div class="form-group">
                        <label>البحث</label>
                        <input type="text" class="form-control" placeholder="البحث بالاسم أو البريد الإلكتروني..." id="searchInput">
                    </div>
                    <div class="form-group">
                        <label>نوع الحساب</label>
                        <select class="form-control" id="accountTypeFilter">
                            <option value="">جميع الأنواع</option>
                            <option value="admin">مدير النظام</option>
                            <option value="driver">سائق</option>
                            <option value="car_rental_office">مكتب توصيل</option>
                            <option value="restaurant">مطعم</option>
                            <option value="real_estate_individual">سمسار</option>
                            <option value="real_estate_office">مكتب عقارات</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الحالة</label>
                        <select class="form-control" id="statusFilter">
                            <option value="">جميع الحالات</option>
                            <option value="1">معتمد</option>
                            <option value="0">غير معتمد</option>
                            <option value="pending">معلق</option>
                            <option value="rejected">مرفوض</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="filterAccounts()">
                        <i class="fas fa-search"></i> بحث
                    </button>
                </div>
            </div>
            
            <!-- Accounts Table -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>الصورة</th>
                            <th>الاسم</th>
                            <th>البريد الإلكتروني</th>
                            <th>نوع الحساب</th>
                            <th>الحالة</th>
                            <th>تاريخ التسجيل</th>
                            <th>آخر دخول</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="accountsTableBody">
                        <!-- البيانات سيتم تحميلها من API -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-container" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" disabled>
                    <i class="fas fa-chevron-right"></i> السابق
                </button>
                <span style="color: var(--dark-gray);">صفحة 1 من 5</span>
                <button class="btn btn-secondary">
                    التالي <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>
    </main>
    
    <!-- Add User Modal -->
    <div id="addUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة مستخدم جديد</h3>
                <span class="close" onclick="closeModal('addUserModal')">×</span>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label>الاسم *</label>
                        <input type="text" id="addUserName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني *</label>
                        <input type="email" id="addUserEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="tel" id="addUserPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>كلمة المرور *</label>
                        <input type="password" id="addUserPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>نوع الحساب *</label>
                        <select id="addUserType" class="form-control" required>
                            <option value="">اختر نوع الحساب</option>
                            <option value="admin">مدير النظام</option>
                            <option value="driver">سائق</option>
                            <option value="car_rental_office">مكتب توصيل</option>
                            <option value="restaurant">مطعم</option>
                            <option value="real_estate_individual">سمسار</option>
                            <option value="real_estate_office">مكتب عقارات</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>حالة الاعتماد *</label>
                        <select id="addUserStatus" class="form-control" required>
                            <option value="">اختر حالة الاعتماد</option>
                            <option value="0">غير معتمد</option>
                            <option value="1" selected>معتمد</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="handleAddUser()">إضافة المستخدم</button>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>تعديل بيانات المستخدم</h3>
                <span class="close" onclick="closeModal('editUserModal')">×</span>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    
                    <!-- Basic Information -->
                    <h4 class="section-title">البيانات الأساسية</h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>الاسم *</label>
                            <input type="text" id="editUserName" class="form-control" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label>البريد الإلكتروني *</label>
                            <input type="email" id="editUserEmail" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>رقم الهاتف</label>
                            <input type="tel" id="editUserPhone" class="form-control">
                        </div>
                        <div class="form-group col-md-6">
                            <label>المحافظة</label>
                            <input type="text" id="editUserGovernorate" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>نوع الحساب *</label>
                            <select id="editUserType" class="form-control" required onchange="showEditSpecificFields()">
                                <option value="admin">مدير النظام</option>
                                <option value="driver">سائق</option>
                                <option value="car_rental_office">مكتب توصيل</option>
                                <option value="restaurant">مطعم</option>
                                <option value="real_estate_individual">سمسار</option>
                                <option value="real_estate_office">مكتب عقارات</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label>حالة الاعتماد *</label>
                            <select id="editUserStatus" class="form-control" required>
                                <option value="0">غير معتمد</option>
                                <option value="1">معتمد</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Dynamic Fields Container -->
                    <div id="editSpecificFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="handleEditUser()">حفظ التغييرات</button>
            </div>
        </div>
    </div>
    
    <!-- View User Modal -->
    <div id="viewUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تفاصيل المستخدم</h3>
                <span class="close" onclick="closeModal('viewUserModal')">×</span>
            </div>
            <div class="modal-body" id="viewUserModalBody">
                <!-- User details will be dynamically injected here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('viewUserModal')">إغلاق</button>
                <button type="button" id="editUserFromViewBtn" class="btn btn-primary" onclick="editUserFromView()">تعديل البيانات</button>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تأكيد الحذف</h3>
                <span class="close" onclick="closeModal('deleteUserModal')">×</span>
            </div>
            <div class="modal-body">
                <div class="delete-warning">
                    <i class="fas fa-exclamation-triangle" style="color: #dc3545; font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>هل أنت متأكد من حذف المستخدم <strong id="deleteUserName"></strong>؟</p>
                    <p style="color: #dc3545; font-size: 0.9rem; margin-top: 1rem;">⚠️ تحذير: هذا الإجراء لا يمكن التراجع عنه وسيتم حذف جميع البيانات المرتبطة بهذا المستخدم نهائياً.</p>
                </div>
                <input type="hidden" id="deleteUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteUserModal')">إلغاء</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">
                    <i class="fas fa-trash"></i> حذف المستخدم نهائياً
                </button>
            </div>
        </div>
    </div>

    <!-- Registration Request Modal -->
    <div id="registrationRequestModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>طلب تسجيل جديد</h3>
                <span class="close" onclick="closeModal('registrationRequestModal')">×</span>
            </div>
            <div class="modal-body" id="registrationRequestModalBody">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>البريد الإلكتروني</th>
                                <th>الهاتف</th>
                                <th>نوع الحساب</th>
                                <th>تاريخ الطلب</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="pendingRequestsTableBody">
                            <!-- Pending requests will be dynamically injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('registrationRequestModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Rejected Requests Modal -->
    <div id="rejectedRequestsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3>الطلبات المرفوضة</h3>
                <span class="close" onclick="closeModal('rejectedRequestsModal')">×</span>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>البريد الإلكتروني</th>
                                <th>نوع الحساب</th>
                                <th>تاريخ الطلب</th>
                                <th>تاريخ الرفض</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="rejectedRequestsTableBody">
                            <!-- Rejected requests will be dynamically injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('rejectedRequestsModal')">إغلاق</button>
            </div>
        </div>
    </div>
    
    <link rel="stylesheet" href="assets/css/accounts.css">
    <script src="assets/js/main.js"></script>
    <script src="assets/js/accounts.js"></script>



    
    <style>
        :root {
            --primary-yellow: #FFC107;
            --dark-gray: #333;
            --primary-gray: #6c757d;
            --light-gray: #f8f9fa;
            --white: #fff;
            --light-yellow: #fff3cd;
        }
        body { font-family: 'Cairo', sans-serif; }
        .badge { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .badge-admin { background: var(--primary-yellow); color: var(--dark-gray); }
        .badge-employee { background: #007bff; color: var(--white); }
        .badge-customer { background: #6c757d; color: var(--white); }
        .status-active { color: #28a745; font-weight: 600; }
        .status-inactive { color: #dc3545; font-weight: 600; }
        .btn-icon { background: none; border: none; padding: 0.5rem; margin: 0 0.25rem; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; color: var(--primary-gray); }
        .btn-icon:hover { background: #e9ecef; }
        .btn-icon.btn-danger:hover { background: #dc3545; color: var(--white); }
        
        /* Modal Styles */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--white); border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: var(--dark-gray); font-size: 1.25rem; }
        .modal-header .close { font-size: 1.5rem; font-weight: bold; color: var(--primary-gray); cursor: pointer; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #dee2e6; display: flex; gap: 1rem; justify-content: flex-end; }
        
        /* View User Modal Specific Styles */
        .user-details-header { text-align: center; margin-bottom: 1.5rem; }
        .view-user-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid var(--primary-yellow); }
        .view-user-initials { width: 100px; height: 100px; border-radius: 50%; background: var(--primary-yellow); color: var(--dark-gray); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; margin: 0 auto 1rem auto; }
        .user-details-header h3 { margin: 0.5rem 0 0.25rem; }
        .user-details-header p { margin: 0; color: var(--primary-gray); }

        .details-subtitle { margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.1rem; border-bottom: 2px solid var(--primary-yellow); padding-bottom: 0.5rem; }
        .user-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .info-row { background-color: var(--light-gray); padding: 0.75rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .info-row label { font-weight: 600; color: var(--dark-gray); margin-left: 1rem; }
        
        /* Edit Modal Specific Styles */
        .section-title { color: var(--dark-gray); font-size: 1.1rem; margin: 1.5rem 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-yellow); }
        .form-row { display: flex; flex-wrap: wrap; margin-right: -0.5rem; margin-left: -0.5rem; }
        .form-group { margin-bottom: 1rem; }
        .col-md-4 { flex: 0 0 33.333333%; max-width: 33.333333%; padding-right: 0.5rem; padding-left: 0.5rem; }
        .col-md-6 { flex: 0 0 50%; max-width: 50%; padding-right: 0.5rem; padding-left: 0.5rem; }
        .form-control { width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; }
        .form-control:focus { border-color: var(--primary-yellow); outline: 0; box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25); }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark-gray); }
        
        @media (max-width: 768px) {
            .col-md-4, .col-md-6 { flex: 0 0 100%; max-width: 100%; }
        }
        .info-row span { color: var(--primary-gray); text-align: left; }
        .info-row span .badge, .info-row span .status-active, .info-row span .status-inactive { font-size: 0.9rem; }
        
        /* Image buttons section styles */
        .image-buttons-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .image-section-title {
            color: var(--dark-gray);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .image-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .image-btn {
            background: linear-gradient(135deg, var(--primary-yellow), #ffb300);
            color: var(--dark-gray);
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #ffb300, var(--primary-yellow));
        }
        
        .image-btn i {
            font-size: 1.1rem;
        }
        
        /* Image modal styles */
        #imageModal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        #imageModal .modal-content {
            background-color: var(--white);
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        #imageModal .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        #imageModal .modal-body {
            padding: 1rem;
            text-align: center;
        }
        
        #imageModal img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 4px;
        }
        
        /* Registration request modal styles */
        .registration-request-modal .modal-content {
            max-width: 1000px;
        }

        /* Request Details Modal Styles */
        .user-details-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .view-user-initials {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .user-details-header h3 {
            margin: 0.5rem 0;
            font-size: 1.5rem;
        }

        .details-subtitle {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 1.5rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .user-details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
        }

        .detail-value {
            color: #212529;
            text-align: left;
        }

        .image-buttons-section {
            margin: 1rem 0;
        }

        .image-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .image-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.8rem 1rem;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .image-btn i {
            font-size: 1.1rem;
        }
        
        .registration-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .registration-table th,
        .registration-table td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid #dee2e6;
        }
        
        .registration-table th {
            background-color: var(--light-gray);
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .registration-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Alert styles */
        .alert {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.375rem;
        }
        
        .alert-success {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        
        .alert-warning {
            color: #664d03;
            background-color: #fff3cd;
            border-color: #ffecb5;
        }
        
        .alert-info {
            color: #055160;
            background-color: #cff4fc;
            border-color: #b6effb;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.5;
        }
        
        .btn-close:hover {
            opacity: 1;
        }
    </style>
    
    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>تفاصيل طلب التسجيل</h3>
                <span class="close" onclick="closeModal('requestDetailsModal')">×</span>
            </div>
            <div class="modal-body" id="requestDetailsBody">
                <!-- Request details will be dynamically injected here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('requestDetailsModal')">إغلاق</button>
                <button type="button" id="approveBtn" class="btn btn-success" onclick="approveCurrentRequest()">
                    <i class="fas fa-check"></i> قبول الطلب
                </button>
                <button type="button" id="rejectBtn" class="btn btn-danger" onclick="rejectCurrentRequest()">
                    <i class="fas fa-times"></i> رفض الطلب
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">عرض الصورة</h3>
                <span class="close" onclick="closeImageModal()">&times;</span>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="صورة المستند">
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/components.js"></script>
    <script src="api/users.js"></script>
</body>
</html>